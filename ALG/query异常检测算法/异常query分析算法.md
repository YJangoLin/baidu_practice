# 异常query分析算法

[TOC]

## 初步构想

### 设计思路

![自动化query异常检测](/Users/liangzonglin/Documents/实习/query异常检测算法/自动化query异常检测.png)







### 思路

#### Translate

对query进行翻译

主要问题：采用api接口对句子进行翻译时，由于query较多会造成网页无返回，连接超时等问题，

解决：将多个句子合并一同翻译，然后根据设置的分隔符将其拆分。



#### Tokenizer

将query转化为token，但是此token只是对句子中每个单词的编号，无距离相似度意义。



#### BERT Model

将token转换为带有单词间关系信息以及相似度信息的向量



#### 奇异值分解

利用奇异值矩阵计算token的特征值，利用特征值去在空间上压缩特征，将其压缩到d_model大小（这里d_model设置为768）



#### 聚类分析

根据k-means算法通过余弦相似度将query划分为2类，及异常query和正常query。





### 结果

我们对domain为music的类别进行划分：划分效果如下：

| 异常query | 正常query        |
| --------- | ---------------- |
| 奥秘      | 请唱一首歌       |
| 学猫叫    | 放首歌           |
| 归位      | 放首歌           |
| 归位      | 唱个歌           |
| 小鸡小鸡  | 你可以放歌听吗   |
| 播放今天  | 给我唱首歌呗     |
| 怎样      | 放学的什么歌     |
| 漂亮      | 可以为我唱首歌吗 |
| 王八蛋    | 我懂了           |
| 回来      | 妹妹房间         |
| 你们      | 想我了吗         |
| 臭臭      | 我想你了         |
| 湿布      | 春眠不觉晓       |
| 找妈妈    | 来找我           |
| 边刷边刷  | 来找我           |
| 你会不会  | 放一首生日快乐歌 |



### 问题以及后续改进方法

问题：

- 对“播放音乐”等query存在一些划分错误的现象，划分的准确率有待提高
- 模型对query的划分过渡依赖与向量的表示。

- 模型在降维时，虽然降低了计算消耗和内存占用，但是一定程度上，丢失了数据的空间维度信息。

后续改进：

- 在特征表示上改进：利用实体抽取模型对句子中的实体关系进行抽取，然后构造一个自己的知识图谱，引入知识，来指导模型进行划分。（缺点：需要大量的数据跟时间去构建图结构，知识如何融入模型需要花费时间去构建）
- 改进聚类算法，采用密度的方法DBSACN, OPTICS, DenClue等或者普聚类算法等无监督算法对其进行改进
- 改造特征：构建特征均值、方差等信息，以及其他相似度信息作为决策变量



## 改进

### 基于Bert的文本分类

![image-20240705153429169](/Users/liangzonglin/Library/Application Support/typora-user-images/image-20240705153429169.png)



#### 初步实现

简化版：先不做修正模块，先进行分类预测

参考模型：https://github.com/649453932/Bert-Chinese-Text-Classification-Pytorch?tab=readme-ov-file





#### 分类模型





#### 实验

##### 参数设置

| 参数          | 值        | 解释                                     |
| ------------- | --------- | ---------------------------------------- |
| num_epochs    | 50        |                                          |
| batch_size    | 128       |                                          |
| pad_size      | 32        | 向量填充至多大，最好和单词的数量保持一致 |
| learning_rate | 5 x 10^-5 | 学习率                                   |
| hidden_size   | 768       | 隐藏层的维度                             |
|               |           |                                          |





#### 结果

不改进：







初步改进 version 1.1

- 利用bert模型将数据向量化
- 融入botName属性
- 线性层进行预测

|       | accuracy | Loss |
| ----- | -------- | ---- |
| Train | 97.66%   | 0.12 |
| Vail  | 67.72%   | 1.8  |
| Test  | 71.46%   | 2.2  |



各个类别分类效果

|                         | precision | recall | f1-score      |      |
| ----------------------- | --------- | ------ | ------------- | ---- |
| failure                 | 0.3000    | 0.1818 | <u>0.2264</u> |      |
| smart_home.clean_robot  | 0.7041    | 0.6263 | 0.6630        |      |
| dreame_clean_function   | 0.5141    | 0.4550 | 0.4828        |      |
| roborock_clean_function | 0.5341    | 0.6821 | 0.5991        |      |
| sys_command             | 0.9402    | 0.9010 | ==0.9202==    |      |
| weather                 | 0.9476    | 1.0000 | ==0.9731==    |      |

- 问题
  - 异常检测效果不佳
  - 模型存在过拟合现象
- 下步改进
  - 采用多支路分类预测（*）
  - 加大数据集(*)
  - 修改损失函数，加大异常query检测的权重
  - 设计修正模块，可以利用一个矩阵去存储偏差数据



#### 问题

- 对于一些domain没有明显的query特征，可以加入设备来区分





smarthome_voice_device_location_info

k5p717g6

342918870f6352d2